@model Fleet_Managment_Production.Models.Trip

@{
    ViewData["Title"] = "Nowa Podróż";
}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

<style>
    #map {
        height: 500px;
        width: 100%;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        position: relative;
        z-index: 1;
    }

    .leaflet-routing-container {
        display: none !important;
    }

    /* Style dla listy podpowiedzi */
    .autocomplete-items {
        position: absolute;
        border: 1px solid #d4d4d4;
        border-bottom: none;
        border-top: none;
        z-index: 9999; /* Musi być nad wszystkim */
        top: 100%;
        left: 0;
        right: 0;
        background-color: #fff;
        border-radius: 0 0 5px 5px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        max-height: 200px;
        overflow-y: auto;
    }

        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            background-color: #fff;
            border-bottom: 1px solid #d4d4d4;
            font-size: 0.9em;
        }

            .autocomplete-items div:hover {
                background-color: #e9e9e9;
            }

            .autocomplete-items div strong {
                color: #0d6efd;
            }

    /* Rodzic inputa musi być relative, żeby lista była pod nim */
    .autocomplete-container {
        position: relative;
    }

    .loader {
        display: none;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
        position: absolute;
        right: 10px;
        top: 38px;
    }

    @@keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Nowa Podróż</h1>
    <a asp-action="Index" class="btn btn-secondary">Powrót</a>
</div>
<hr />

<div class="row">
    <div class="col-md-5">
        <form asp-action="Create">
            <div asp-validation-summary="All" class="text-danger"></div>

            <input type="hidden" asp-for="StartLatitude" id="startLat" />
            <input type="hidden" asp-for="StartLongitude" id="startLng" />
            <input type="hidden" asp-for="EndLatitude" id="endLat" />
            <input type="hidden" asp-for="EndLongitude" id="endLng" />
            <input type="hidden" asp-for="EstimatedDistanceKm" id="estDistance" />

            <div class="card mb-3 shadow-sm border-primary">
                <div class="card-header bg-primary text-white">1. Planowanie Trasy</div>
                <div class="card-body">

                    <div class="mb-2 autocomplete-container">
                        <label asp-for="StartLocation" class="control-label">Miejsce startu</label>
                        <input asp-for="StartLocation" class="form-control" id="startInput" placeholder="Zacznij pisać (np. Warszawa)..." autocomplete="off" />
                        <div id="startLoader" class="loader"></div>
                        <div id="startList" class="autocomplete-items" style="display:none;"></div>
                        <span asp-validation-for="StartLocation" class="text-danger"></span>
                    </div>

                    <div class="mb-2 autocomplete-container">
                        <label asp-for="EndLocation" class="control-label">Miejsce docelowe</label>
                        <input asp-for="EndLocation" class="form-control" id="endInput" placeholder="Zacznij pisać (np. Kraków)..." autocomplete="off" />
                        <div id="endLoader" class="loader"></div>
                        <div id="endList" class="autocomplete-items" style="display:none;"></div>
                        <span asp-validation-for="EndLocation" class="text-danger"></span>
                    </div>

                    <div class="alert alert-light border mt-3 text-center mb-0">
                        <div class="small text-muted mb-1">Dystans trasy:</div>
                        <strong id="displayDistance" class="text-primary" style="font-size: 1.4em;">0 km</strong>
                    </div>
                </div>
            </div>

            <div class="card mb-3 shadow-sm">
                <div class="card-body">
                    <div class="mb-2">
                        <label asp-for="VehicleId" class="control-label"></label>
                        <select asp-for="VehicleId" class="form-control" asp-items="ViewBag.VehicleId"></select>
                    </div>
                    <div class="mb-2">
                        <label asp-for="DriverId" class="control-label"></label>
                        <select asp-for="DriverId" class="form-control" asp-items="ViewBag.DriverId"></select>
                    </div>
                </div>
            </div>

            <div class="card mb-3 shadow-sm">
                <div class="card-body">
                    <div class="row">
                        <div class="col-6 mb-2">
                            <label asp-for="StartOdometer" class="control-label"></label>
                            <input asp-for="StartOdometer" class="form-control" />
                            <span asp-validation-for="StartOdometer" class="text-danger"></span>
                        </div>
                        <div class="col-6 mb-2">
                            <label asp-for="EndOdometer" class="control-label"></label>
                            <input asp-for="EndOdometer" class="form-control" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-2">
                            <label asp-for="StartDate" class="control-label"></label>
                            <input asp-for="StartDate" class="form-control" />
                        </div>
                        <div class="col-6 mb-2">
                            <label asp-for="TripType" class="control-label"></label>
                            <select asp-for="TripType" class="form-control" asp-items="Html.GetEnumSelectList<Fleet_Managment_Production.Models.TripType>()"></select>
                        </div>
                    </div>
                    <div class="mb-2">
                        <label asp-for="Description" class="control-label"></label>
                        <textarea asp-for="Description" class="form-control" rows="2"></textarea>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn btn-success w-100 py-3 fw-bold" style="font-size: 1.1em;">ZAPISZ PODRÓŻ</button>
        </form>
    </div>

    <div class="col-md-7">
        <div id="map"></div>
        <div class="text-muted small mt-1 text-end">© OpenStreetMap contributors</div>
    </div>
</div>
@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <script>
        // --- 1. Konfiguracja Mapy ---
        var map = L.map('map').setView([52.0693, 19.4803], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        var routingControl = L.Routing.control({
            waypoints: [],
            routeWhileDragging: false,
            showAlternatives: false,
            addWaypoints: false,
            createMarker: function(i, wp) {
                return L.marker(wp.latLng).bindPopup(i === 0 ? "Start" : "Cel");
            }
        }).addTo(map);

        routingControl.on('routesfound', function(e) {
            var distanceKm = (e.routes[0].summary.totalDistance / 1000).toFixed(1);
            document.getElementById('displayDistance').innerText = distanceKm + " km";
            // Tu też zamieniamy kropkę na przecinek dla serwera
            document.getElementById('estDistance').value = distanceKm.replace('.', ',');
        });

        // --- 2. Mechanizm Autocomplete ---

        // Konfiguracja podpowiedzi dla pola START
        setupAutocomplete(
            document.getElementById('startInput'),
            document.getElementById('startList'),
            document.getElementById('startLoader'),
            (lat, lng) => {
                // Zapisujemy z PRZECINKIEM dla serwera (C#)
                document.getElementById('startLat').value = lat.toString().replace('.', ',');
                document.getElementById('startLng').value = lng.toString().replace('.', ',');
                tryUpdateRoute();
            }
        );

        // Konfiguracja podpowiedzi dla pola KONIEC
        setupAutocomplete(
            document.getElementById('endInput'),
            document.getElementById('endList'),
            document.getElementById('endLoader'),
            (lat, lng) => {
                // Zapisujemy z PRZECINKIEM dla serwera (C#)
                document.getElementById('endLat').value = lat.toString().replace('.', ',');
                document.getElementById('endLng').value = lng.toString().replace('.', ',');
                tryUpdateRoute();
            }
        );

        // Funkcja główna do obsługi autouzupełniania
        function setupAutocomplete(input, listContainer, loader, callbackSelect) {
            let timeoutId;

            input.addEventListener('input', function() {
                const query = this.value;

                listContainer.innerHTML = '';
                listContainer.style.display = 'none';
                clearTimeout(timeoutId);

                if (!query || query.length < 3) return;

                timeoutId = setTimeout(() => {
                    loader.style.display = 'block';

                    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5&countrycodes=pl`)
                        .then(response => response.json())
                        .then(data => {
                            loader.style.display = 'none';
                            listContainer.innerHTML = '';

                            if (data.length > 0) {
                                listContainer.style.display = 'block';
                                data.forEach(item => {
                                    let displayName = item.display_name;
                                    if(displayName.length > 60) displayName = displayName.substring(0, 60) + "...";

                                    const div = document.createElement('div');
                                    div.innerHTML = `<strong>${item.name || query}</strong> <br/><small class="text-muted">${displayName}</small>`;

                                    div.addEventListener('click', function() {
                                        input.value = item.display_name;
                                        listContainer.style.display = 'none';
                                        callbackSelect(item.lat, item.lon);
                                    });

                                    listContainer.appendChild(div);
                                });
                            }
                        })
                        .catch(err => {
                            console.error(err);
                            loader.style.display = 'none';
                        });
                }, 500);
            });

            document.addEventListener('click', function(e) {
                if (e.target !== input) {
                    listContainer.style.display = 'none';
                }
            });
        }

        // --- 3. Funkcja aktualizująca trasę (POPRAWIONA) ---
        function tryUpdateRoute() {
            // Pobieramy wartości z ukrytych pól (które mogą mieć przecinki)
            let startLat = document.getElementById('startLat').value;
            let startLng = document.getElementById('startLng').value;
            let endLat = document.getElementById('endLat').value;
            let endLng = document.getElementById('endLng').value;

            // ZAMIENIAMY Przecinki na Kropki (tylko na potrzeby JavaScript/Mapy)
            startLat = startLat.replace(',', '.');
            startLng = startLng.replace(',', '.');
            endLat = endLat.replace(',', '.');
            endLng = endLng.replace(',', '.');

            // Uruchom trasę tylko jeśli mamy komplet punktów
            if (startLat && startLng && endLat && endLng) {
                // Sprawdzamy czy to poprawne liczby
                if (!isNaN(startLat) && !isNaN(startLng) && !isNaN(endLat) && !isNaN(endLng)) {
                    const startPoint = L.latLng(startLat, startLng);
                    const endPoint = L.latLng(endLat, endLng);

                    routingControl.setWaypoints([startPoint, endPoint]);

                    var bounds = L.latLngBounds(startPoint, endPoint);
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            }
        }
    </script>
}